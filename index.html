<!DOCTYPE html>
<HTML>
<HEAD>
<meta charset="UTF-8">
<title>スロット</title>
<style type="text/css">
<!--
/* height-size */
.h240 {
	height:240px;
}
.h60 {
	height:60px;
}
.font20px {
	font-size:20px;
}
.font30px {
	font-size:30px;
}

/* point-list */
table.tbl_point-list {
	border:0px;
}
table.tbl_point-list img {
	width:69px;
	height:50px;
}

/* slot-style */
.row_slot {
	height: 300px;
	max-height: 300px;
	min-height: 300px;
}
.row_slot > td {
		min-width:300px;
		max-width:300px;
		text-align:center;
}

.row_credit td{
	font-size:30px;
}

.row_slot .img_sizemax {
	width:100%;
	height:100%;
	border:0px;
}

.row_button {
	height: 100px;
}

.row_button .btn_stop {
	width:100%;
	height:90%;
	font-size:30px;
}

.row_button .btn_start {
	width:100%;
	height:80px;
	font-size:30px;
}
-->
</style>
<script language="JavaScript">
<!--
/** お勉強のためJSソースを外部ファイルにしてません **/

/// 定数 ///
var FORMAT_CREDIT = '0000000000';
/// グローバル変数 ///
var aryTimerId = new Array(0,0,0); //リール用タイマー
var aryEndCheck = new Array(0,0,0) //STOP判定
var aryDetect = new Array(-1,-1,-1); //当たり判定
var stg = window.localStorage; //WebStorage
var gblnChecks = { chk_mustdet: false, chk_msgdisplay: true }; //チェックボックス設定
var gnumCredit = 0; //クレジット
var gnumDetectId = 0; //確定当たり番号

/**
* 0埋めのテキストフォーマット
* @param {number} target - 数値
* @param {string} format - 埋めたい文字列
*/
var format_text = function(target, format){
	var len = format.length;
	target = Math.abs(target); //TODO: マイナスの場合どう表示するか検討
	
	return String(format + target).slice((-1 * len));
};

/**
* 当たり時の更新処理
* @param {number} add_point - 数値
*/
var set_point = function(add_point){
	var numPoint = 0;
	var i = 1;
	var j = gnumCredit;
	var objTimerID = 0;

	var countupPoint = function(){
		var objTimerID = setTimeout(countupPoint, 1);
		i++;
		if(i <= add_point){
			gnumCredit = parseInt(j) + parseInt(i);
			document.getElementById('lblCredit').innerText = format_text(gnumCredit, FORMAT_CREDIT);
		}else{
			clearTimeout(objTimerID);
		}
	};
	countupPoint();

	gnumCredit = j + parseInt(add_point);
	document.getElementById('lblCredit').innerText = format_text(gnumCredit, FORMAT_CREDIT);

	/// WebStorage版
	stg.setItem("credit", gnumCredit);
};

/**
* チェック設定変更
* @param {string} id - チェックオブジェクトID
*/
var onchange_check = function(id){
	if(document.getElementById(id).checked){
		gblnChecks[id] = true;
	}else{
		gblnChecks[id] = false;
	}
	stg.setItem(id, gblnChecks[id]);
};

/**
* 初期表示処理
* @param なし
*/
var init_page = function(){
	/// 変数の初期化
	var numPoint = 1000;
	
	/// 設定読み込み(WebStorage)
	// チェックオブジェクトを設定
	key = "chk_mustdet";
	if (stg.getItem(key)){
		gblnChecks[key] = eval(stg.getItem(key));
	}
	document.getElementById(key).checked = gblnChecks[key];
	key = "chk_msgdisplay";
	if (stg.getItem(key)){
		gblnChecks[key] = eval(stg.getItem(key));
	}
	document.getElementById(key).checked = gblnChecks[key];

	// クレジットを設定
	if (stg.getItem("credit")){
		numPoint = stg.getItem("credit");
	}
	gnumCredit = parseInt(numPoint);
	
	document.getElementById("lblCredit").innerText = format_text(gnumCredit, FORMAT_CREDIT);
};

/**
* スロット初期化処理(スタート)
* @param なし
*/
var init_slot = function(){
	var n = 0;
	var m = gnumCredit;

	document.getElementById("btn_start").disabled = true;
	gnumDetectId = Math.floor((Math.random(1)*Math.random(1))*5+1);

	var countdownPoint = function(){
	
		var objTimerID = setTimeout(countdownPoint, 1);
		n++;

		if(n > 100){
			clearTimeout(objTimerID);
		}else{
			numPoint = parseInt(m) - parseInt(n);
			document.getElementById('lblCredit').innerText = format_text(numPoint, FORMAT_CREDIT)
		}
	};
	countdownPoint();

	gnumCredit -= 100;

	for(var i=0; i<3; i++){
		//変数の初期化
		aryEndCheck[i] = 0;
		aryDetect[i] = -1;
		clearTimeout(aryTimerId[i]);
		//スロットスタート
		document.getElementById("cel_id"+i).style.backgroundColor="#FFFFFF";
		document.getElementById("btn_id"+i).disabled = false;
		start_slot(i);
	}
};

/**
* スロット初期化処理(スタート)
* @param {number} index - リール番号
* @param {number} interval - タイマー間隔
*/
var start_slot = function(index, interval){
	if(interval == undefined){
		interval = 50;
	}

	// 0に近い値の確立を高めに設定
	numRnd = Math.floor((Math.random(1)*Math.random(1))*5+1);

	document.getElementById("img_id"+index).src = "img/au" + numRnd + ".png";
	aryDetect[index] = numRnd;

	if(interval < 500){
		//STOP処理でインターバルが変更されたら少しずつ長くする
		if(interval != 50){
			interval = interval + 50;
		}
		aryTimerId[index]=setTimeout(start_slot, interval, index, interval);

	}else{
		//あたり確定の場合は指定の画像と値を設定する
		console.log(gblnChecks['chk_mustdet']);
		if(gblnChecks['chk_mustdet'] == true){
			document.getElementById("img_id"+index).src = "img/au" + gnumDetectId + ".png";
			aryDetect[index] = gnumDetectId;
		}

		document.getElementById("cel_id"+index).style.backgroundColor="#FFFF00";
		aryEndCheck[index] = 1;
		setTimeout(detection_slot,100);
	}
};

/**
* スロットストップ処理
* @param {number} index - リール番号
*/
var stop_slot = function(index){
	document.getElementById("btn_id"+index).disabled = true;
	
	if(aryEndCheck[index] == 0){
		clearTimeout(aryTimerId[index]);
		aryTimerId[index] = start_slot(index, 100);
	}
};

/**
* あたり判定処理
* @param なし
*/
var detection_slot = function(){
	var blnDetect = false;
	var numPoint = 0;

	for(var i=0; i<3; i++){
		if(aryEndCheck[i] == 1){
			if(i > 0){
				if(aryDetect[i] == aryDetect[i-1]){
					blnDetect = true;
				}else{
					blnDetect = false;
					break;
				}
			}
		}else{
			blnDetect = false;
			break;
		}
	}
	
	if(blnDetect){
		numPoint = aryDetect[0] * aryDetect[0] *100;

		if(gblnChecks['chk_msgdisplay'] == true){
			alert("あたり！！おめでとう！！\n" + numPoint + "コイン");
		}
		set_point(numPoint);
	}

	for(var i=0; i<3; i++){
		if(i==2 && aryEndCheck[i] == 1 ){
			document.getElementById("btn_start").disabled = false;
		}else if( aryEndCheck[i] != 1 ){
			break;
		}
	}
};

function audio() {
    document.getElementById('btn_stop_audio').currentTime = 0; //連続クリックに対応
    document.getElementById('btn_stop_audio').play(); //クリックしたら音を再生
}

//-->
</script>

<audio id="btn_stop_audio">
    <source src="audio/au.mp3" type="audio/mp3">
</audio>

</HEAD>

<BODY onload="init_page();">
<HR>
<H1>スロット</H1>
<HR>
<TABLE border="5" align="center">
<TR class="row_credit font30px">
	<TD align="right">
		<span>
			クレジット
		</span>
	</TD>
	<TD colspan="2" align="left">
		<span id="lblCredit">0000000000</span>
	</TD>
</TR>
<TR class="row_slot">
	<TD id="cel_id0">
		<IMG class="img_sizemax" src="img/au1.png" id="img_id0">
	</TD>
	<TD id="cel_id1">
		<IMG class="img_sizemax" src="img/au1.png" id="img_id1">
	</TD>
	<TD id="cel_id2">
		<IMG class="img_sizemax" src="img/au1.png" id="img_id2">
	</TD>
</TR>
<TR class="row_button">
	<TD class="h60" align="center">
		<input class="btn_stop" type="button" id="btn_id0" value="STOP" onClick="stop_slot(0);audio()" disabled>
	</TD>
	<TD class="h60" align="center">
		<input class="btn_stop" type="button" id="btn_id1" value="STOP" onClick="stop_slot(1);audio()" disabled>
	</TD>
	<TD class="h60" align="center">
		<input class="btn_stop" type="button" id="btn_id2" value="STOP" onClick="stop_slot(2);audio()" disabled>
	</TD>
</TR>
<TR class="row_button">
	<TD colspan="3">
		<input class="btn_start" type="button" id="btn_start" value="START" onClick="init_slot(); audio()">
	</TD>
</TR>
<TR>
	<TD colspan="3" align="left">
	<SPAN class="font20px">
		当たり一覧表
		<TABLE class="tbl_point-list">
		<TR><TD><img src="img/au1.png"><img src="img/au1.png"><img src="img/au1.png"></TD><TD>100コイン</TD></TR>
		<TR><TD><img src="img/au2.png"><img src="img/au2.png"><img src="img/au2.png"></TD><TD>400コイン</TD></TR>
		<TR><TD><img src="img/au3.png"><img src="img/au3.png"><img src="img/au3.png"></TD><TD>900コイン</TD></TR>
		<TR><TD><img src="img/au4.png"><img src="img/au4.png"><img src="img/au4.png"></TD><TD>1600コイン</TD></TR>
		<TR><TD><img src="img/au5.png"><img src="img/au5.png"><img src="img/au5.png"></TD><TD>2500コイン</TD></TR>
		</TABLE>
	</SPAN>
	</TD>
</TR>
</TABLE>

<input type="checkbox" id="chk_mustdet" onClick="onchange_check('chk_mustdet');"><label for="chk_mustdet">当たり確定セット</label><br>
<input type="checkbox" id="chk_msgdisplay" onClick="onchange_check('chk_msgdisplay');"><label for="chk_msgdisplay">当たりメッセージ表示</label><br>

</BODY>
</HTML>